<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stories Player – Witchy British VO</title>
<style>
  body{font-family: system-ui,-apple-system,Segoe UI,Roboto; background:#0b0e19; color:#eaeaea; padding:24px}
  .wrap{max-width:900px;margin:0 auto}
  h1{margin:0 0 8px}
  .sub{opacity:.8;margin-bottom:20px}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  audio{width:100%}
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px;margin:12px 0}
  .btn{background:#7bd389;border:none;color:#102;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
  .small{opacity:.8;font-size:.9em}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Witchy British Narration</h1>
    <div class="sub">Dark fantasy reading with Dragon-Age-style ambience. Uses your browser speech engine (en-GB) plus looping background music.</div>

    <div class="card">
      <div class="row">
        <button id="playAll" class="btn">Play All</button>
        <button id="stopAll" class="btn" style="background:#f28181;color:#1b0">Stop</button>
      </div>
      <div class="small">Tip: On macOS, go to System Settings → Accessibility → Spoken Content → Voices and add an enhanced British English voice for higher quality.</div>
    </div>

    <div class="card">
      <div class="row">
        <label>Ambience volume <input id="bgVol" type="range" min="0" max="1" step="0.01" value="0.35"/></label>
        <label>VO rate <input id="voRate" type="range" min="0.6" max="1.2" step="0.05" value="0.9"/></label>
        <label>VO pitch <input id="voPitch" type="range" min="0.6" max="1.4" step="0.05" value="0.95"/></label>
      </div>
      <audio id="bg" src="./music/dragon_age_style_loop.mp3" loop></audio>
      <div class="small">Music: ambient loop placeholder (use your own licensed track at docs/stories/music/dragon_age_style_loop.mp3).</div>
    </div>

    <div id="stories"></div>
  </div>

<script>
(async function(){
  // Load stories text (rewritten) and optionally raw for reference
  let stories=[];
  try{
    stories = await (await fetch('./stories_rewritten.json', {cache:'no-store'})).json();
  }catch(e){
    console.warn('No rewritten stories, falling back to raw.');
    const txt = await (await fetch('../stories_raw.txt', {cache:'no-store'})).text();
    stories = txt.split(/\n\s*\n/).map((t,i)=>({title:`Story ${i+1}`, text:t.trim()})).filter(s=>s.text);
  }

  const wrap = document.getElementById('stories');
  const bg = document.getElementById('bg');
  const bgVol = document.getElementById('bgVol');
  const voRate = document.getElementById('voRate');
  const voPitch = document.getElementById('voPitch');

  bg.volume = parseFloat(bgVol.value);
  bgVol.addEventListener('input', ()=> bg.volume=parseFloat(bgVol.value));

  function speak(text){
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-GB';
    utter.rate = parseFloat(voRate.value);
    utter.pitch = parseFloat(voPitch.value);
    const voices = speechSynthesis.getVoices();
    const preferred = voices.find(v=>/UK|British/i.test(v.name)) || voices.find(v=>/en-GB/i.test(v.lang)) || voices[0];
    if(preferred) utter.voice = preferred;
    speechSynthesis.speak(utter);
    return utter;
  }

  function stopAll(){ speechSynthesis.cancel(); bg.pause(); }

  // Render
  stories.forEach((s,idx)=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <h3>${s.title||('Story '+(idx+1))}</h3>
      <p class="small" style="white-space:pre-wrap;opacity:.9">${(s.text||'').slice(0,400)}${(s.text||'').length>400?'…':''}</p>
      <div class="row">
        <button class="btn playOne">Play</button>
        <button class="btn stopOne" style="background:#f28181;color:#1b0">Stop</button>
      </div>`;
    wrap.appendChild(card);
    const [playBtn, stopBtn] = card.querySelectorAll('button');
    playBtn.addEventListener('click', async()=>{ try { await bg.play(); } catch(e){} speak(s.text); });
    stopBtn.addEventListener('click', stopAll);
  });

  document.getElementById('playAll').addEventListener('click', async()=>{
    try{ await bg.play(); }catch(e){}
    (function chain(i=0){
      if(i>=stories.length) return;
      const u = speak(stories[i].text);
      u.onend = ()=> chain(i+1);
    })();
  });
  document.getElementById('stopAll').addEventListener('click', stopAll);
})();
</script>
</body>
</html>
