<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abstract Garden - Souls of Creation</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Crimson+Text:ital@0;1&family=JetBrains+Mono:wght@300;400&display=swap');
        
        /* FromSoft Dark Theme - No gradients, pure darkness */
        :root {
            --blood-dark: #0A0806;
            --ash-black: #141210;
            --stone-dark: #1C1A17;
            --ember-glow: #B8860B;
            --blood-red: #8B0000;
            --soul-blue: #4169E1;
            --pale-text: #C4B5A0;
            --faded-text: #8B8378;
            --border-iron: #3A3532;
            --success-green: #2F4F2F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: var(--blood-dark);
            color: var(--pale-text);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Subtle fog effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23000" opacity="0.03" width="1" height="1" x="50" y="50"/></svg>');
            pointer-events: none;
            opacity: 0.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
        }

        /* Header - FromSoft Title Style */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-iron);
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 3.5rem;
            font-weight: 600;
            color: var(--ember-glow);
            text-transform: uppercase;
            letter-spacing: 0.3rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .subtitle {
            font-style: italic;
            color: var(--faded-text);
            font-size: 1.1rem;
            letter-spacing: 0.1rem;
        }

        .badge {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1.5rem;
            background: var(--stone-dark);
            border: 1px solid var(--border-iron);
            color: var(--faded-text);
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 300;
        }

        /* Currency Bar - Souls Style */
        .souls-bar {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--ash-black);
            border: 1px solid var(--border-iron);
        }

        .soul-counter {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .soul-icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }

        .soul-value {
            font-size: 1.25rem;
            color: var(--pale-text);
            font-weight: 400;
        }

        /* Stats Grid - Minimal Dark Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--stone-dark);
            border: 1px solid var(--border-iron);
            padding: 1.5rem;
            position: relative;
            transition: border-color 0.3s;
        }

        .stat-card:hover {
            border-color: var(--ember-glow);
        }

        .stat-label {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--faded-text);
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            color: var(--ember-glow);
            font-weight: 300;
        }

        .stat-subtitle {
            font-size: 0.85rem;
            color: var(--faded-text);
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* Progress Section - Estus Flask Style */
        .estus-progress {
            background: var(--ash-black);
            border: 1px solid var(--border-iron);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-title {
            font-family: 'Cinzel', serif;
            font-size: 1.25rem;
            color: var(--pale-text);
        }

        .progress-bar {
            height: 8px;
            background: var(--blood-dark);
            border: 1px solid var(--border-iron);
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--ember-glow);
            transition: width 1s ease;
            box-shadow: 0 0 10px var(--ember-glow);
        }

        .progress-message {
            margin-top: 1rem;
            color: var(--faded-text);
            font-style: italic;
            text-align: center;
        }

        /* Sprint Cards - Bonfire Style */
        .bonfire-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .bonfire-card {
            background: var(--stone-dark);
            border: 1px solid var(--border-iron);
            padding: 1.5rem;
            position: relative;
        }

        .bonfire-card.lit {
            border-color: var(--ember-glow);
            box-shadow: inset 0 0 20px rgba(184, 134, 11, 0.1);
        }

        .bonfire-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .bonfire-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--pale-text);
        }

        .bonfire-progress {
            height: 4px;
            background: var(--blood-dark);
            margin-bottom: 0.5rem;
        }

        .bonfire-flame {
            height: 100%;
            background: var(--ember-glow);
            transition: width 0.6s;
        }

        /* Memory Grid - Soul Fragment Style */
        .memory-chamber {
            background: var(--ash-black);
            border: 1px solid var(--border-iron);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .soul-fragment {
            aspect-ratio: 1;
            background: var(--stone-dark);
            border: 1px solid var(--border-iron);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--faded-text);
        }

        .soul-fragment.obtained {
            background: var(--ember-glow);
            color: var(--blood-dark);
            border-color: var(--ember-glow);
            box-shadow: 0 0 10px rgba(184, 134, 11, 0.5);
        }

        .soul-fragment:hover {
            transform: scale(1.1);
            border-color: var(--ember-glow);
        }

        /* Audio Controls - Item Menu Style */
        .item-menu {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .menu-item {
            padding: 0.75rem 1.5rem;
            background: var(--stone-dark);
            border: 1px solid var(--border-iron);
            color: var(--pale-text);
            font-family: 'Crimson Text', serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background: var(--ash-black);
            border-color: var(--ember-glow);
        }

        .menu-item.active {
            background: var(--ember-glow);
            color: var(--blood-dark);
        }

        /* Story Panels - Covenant Style */
        .covenant-section {
            margin-top: 2rem;
        }

        .covenant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .covenant-card {
            background: var(--stone-dark);
            border: 1px solid var(--border-iron);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .covenant-card.joined {
            border-color: var(--soul-blue);
            box-shadow: inset 0 0 20px rgba(65, 105, 225, 0.1);
        }

        .covenant-card:hover {
            border-color: var(--ember-glow);
        }

        .covenant-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            color: var(--pale-text);
            margin-bottom: 0.5rem;
        }

        .covenant-progress {
            font-size: 0.9rem;
            color: var(--faded-text);
        }

        /* Modal - Dark Sign Style */
        .dark-sign-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 8, 6, 0.95);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--stone-dark);
            border: 2px solid var(--border-iron);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--ember-glow);
            margin-bottom: 1rem;
        }

        .modal-text {
            color: var(--pale-text);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        /* Error Message */
        .error-message {
            background: var(--blood-red);
            color: var(--pale-text);
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid darkred;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .bonfire-grid { grid-template-columns: 1fr; }
            .memory-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Abstract Garden</h1>
            <p class="subtitle">The Souls of Digital Creation</p>
            <div class="badge">BEARER OF THE RENDER • SEEK THE FORGOTTEN STORIES</div>
        </div>

        <!-- Soul Counter -->
        <div class="souls-bar">
            <div class="soul-counter">
                <span class="soul-icon">✦</span>
                <span class="soul-value" id="xp-display">0 SOULS</span>
            </div>
            <div class="soul-counter">
                <span class="soul-icon">◈</span>
                <span class="soul-value" id="coins-display">0 EMBERS</span>
            </div>
        </div>

        <!-- Main Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Portfolio Worth</div>
                <div class="stat-value" id="portfolio-value">$0</div>
                <div class="stat-subtitle">The weight of thy creations</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Monthly Tithe</div>
                <div class="stat-value" id="monthly-income">$0</div>
                <div class="stat-subtitle">Passive souls gathered</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Soul Level</div>
                <div class="stat-value" id="level">1</div>
                <div class="stat-subtitle" id="level-title">Hollow</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">Tasks Vanquished</div>
                <div class="stat-value" id="tasks-complete">0/78</div>
                <div class="stat-subtitle">Issues laid to rest</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="estus-progress">
            <div class="progress-header">
                <div class="progress-title">Journey Progress</div>
                <div id="progress-percentage">0%</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="main-progress" style="width: 0%"></div>
            </div>
            <div class="progress-message" id="progress-message">
                Thou art yet to begin thy journey, Hollow one...
            </div>
        </div>

        <!-- Sprint Bonfires -->
        <div class="bonfire-grid">
            <div class="bonfire-card" id="sprint-1">
                <div class="bonfire-header">
                    <div class="bonfire-title">First Flame</div>
                    <div>0%</div>
                </div>
                <div class="bonfire-progress">
                    <div class="bonfire-flame" style="width: 0%"></div>
                </div>
                <div class="stat-subtitle">Foundation • 8 trials</div>
            </div>
            
            <div class="bonfire-card" id="sprint-2">
                <div class="bonfire-header">
                    <div class="bonfire-title">Kiln of Skills</div>
                    <div>0%</div>
                </div>
                <div class="bonfire-progress">
                    <div class="bonfire-flame" style="width: 0%"></div>
                </div>
                <div class="stat-subtitle">Core mastery • 28 trials</div>
            </div>
            
            <div class="bonfire-card" id="sprint-3">
                <div class="bonfire-header">
                    <div class="bonfire-title">Throne of Want</div>
                    <div>0%</div>
                </div>
                <div class="bonfire-progress">
                    <div class="bonfire-flame" style="width: 0%"></div>
                </div>
                <div class="stat-subtitle">Advanced arts • 20 trials</div>
            </div>
            
            <div class="bonfire-card" id="side-quests">
                <div class="bonfire-header">
                    <div class="bonfire-title">Hidden Paths</div>
                    <div>0%</div>
                </div>
                <div class="bonfire-progress">
                    <div class="bonfire-flame" style="width: 0%"></div>
                </div>
                <div class="stat-subtitle">Side quests • 0 found</div>
            </div>
        </div>

        <!-- Memory Chamber -->
        <div class="memory-chamber">
            <div class="progress-header">
                <div class="progress-title">Memory Fragments</div>
                <div><span id="memories-unlocked">0</span>/49 recovered</div>
            </div>
            <div class="memory-grid" id="memory-grid">
                <!-- Generated by JS -->
            </div>
            <div class="item-menu">
                <button class="menu-item" id="vo-toggle">Voice: Silent</button>
                <button class="menu-item" id="music-toggle">Ambience: Silent</button>
                <button class="menu-item" id="story-mode">Read Chronicles</button>
            </div>
        </div>

        <!-- Covenant Stories -->
        <div class="covenant-section">
            <div class="progress-title" style="margin-bottom: 1rem;">Hidden Covenants</div>
            <div class="covenant-grid" id="covenant-grid">
                <div class="covenant-card">
                    <div class="covenant-name">The Forgotten Women</div>
                    <div class="covenant-progress">Requires completion of hidden trials</div>
                </div>
                <div class="covenant-card">
                    <div class="covenant-name">The Eastern Masters</div>
                    <div class="covenant-progress">Seek the forgotten algorithms</div>
                </div>
                <div class="covenant-card">
                    <div class="covenant-name">The Open Source Heroes</div>
                    <div class="covenant-progress">Liberation through shared knowledge</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dark Sign Modal -->
    <div class="dark-sign-modal" id="story-modal">
        <div class="modal-content">
            <div class="modal-title" id="story-title">Memory Fragment</div>
            <div class="modal-text" id="story-content">
                The echoes of forgotten knowledge whisper through the digital void...
            </div>
            <button class="menu-item" onclick="document.getElementById('story-modal').style.display='none'">
                Return to the Waking World
            </button>
        </div>
    </div>

    <!-- Load game modules -->
    <script src="js/memory-fragments.js"></script>
    <script src="js/audio-system.js"></script>
    <script type="module" src="js/game-state.js"></script>
    <script type="module" src="js/dashboard-integration.js"></script>
    <script type="module" src="js/story-system.js"></script>
    
    <script>
        // Global state
        let issues = [];
        let completedTasks = 0; // Fix: Define at global scope
        let totalTasks = 0;
        
        async function loadData() {
            try {
                const repo = 'Studio-Dashosa/abstract-garden-video';
                
                // Try local data first
                try {
                    const local = await fetch('./data/issues.json', { cache: 'no-store' });
                    if (local.ok) {
                        issues = await local.json();
                    } else {
                        throw new Error('No local data');
                    }
                } catch (_) {
                    // Fallback to GitHub API
                    const issuesResponse = await fetch(`https://api.github.com/repos/${repo}/issues?state=all&per_page=100`, {
                        headers: { 'Accept': 'application/vnd.github.v3+json' }
                    });
                    if (!issuesResponse.ok) {
                        throw new Error(`GitHub API Error: ${issuesResponse.status}`);
                    }
                    issues = await issuesResponse.json();
                }

                updateDashboard();
                generateMemoryGrid();
            } catch (error) {
                console.error('Error loading data:', error);
                document.body.innerHTML += `<div class="error-message">Failed to commune with the GitHub spirits: ${error.message}</div>`;
            }
        }

        function updateDashboard() {
            if (!issues.length) return;

            // Get all real issues (78 total)
            const realIssues = issues.filter(issue => !issue.pull_request);
            const closedIssues = realIssues.filter(issue => issue.state === 'closed');
            
            completedTasks = closedIssues.length;
            totalTasks = realIssues.length;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            // Calculate values
            const portfolioValue = calculatePortfolioValue(completedTasks);
            const monthlyIncome = Math.round(portfolioValue * 0.2);
            const xp = completedTasks * 100;
            const level = calculateLevel(xp);
            
            // Update DOM
            document.getElementById('portfolio-value').textContent = `$${portfolioValue.toLocaleString()}`;
            document.getElementById('monthly-income').textContent = `$${monthlyIncome}`;
            document.getElementById('tasks-complete').textContent = `${completedTasks}/${totalTasks}`;
            document.getElementById('progress-percentage').textContent = `${progress}%`;
            document.getElementById('main-progress').style.width = `${progress}%`;
            document.getElementById('level').textContent = level;
            document.getElementById('level-title').textContent = getSoulTitle(level);
            document.getElementById('xp-display').textContent = `${xp} SOULS`;
            document.getElementById('coins-display').textContent = `${completedTasks * 75} EMBERS`;
            
            // Update progress message
            const messages = [
                "Thou art yet to begin thy journey, Hollow one...",
                "The First Flame flickers. Thy path begins to reveal itself...",
                "Souls gathered. The ancient knowledge stirs within thee...",
                "The machine spirits acknowledge thy dedication, Bearer of the Render...",
                "Halfway through thy trials. The digital realm bends to thy will...",
                "Mastery approaches. Soon thou shalt transcend mortality...",
                "Near the throne. The cycle nears completion...",
                "Thou hast linked the Fire. The Age of Dark is forestalled..."
            ];
            
            const messageIndex = Math.min(Math.floor(progress / 12.5), messages.length - 1);
            document.getElementById('progress-message').textContent = messages[messageIndex];
            
            updateSprintProgress(closedIssues);
        }

        function calculatePortfolioValue(completed) {
            const baseValue = completed * 150;
            const levelBonus = Math.floor(completed / 10) * 500;
            const masterworkBonus = completed >= 78 ? 15000 : 0;
            return baseValue + levelBonus + masterworkBonus;
        }

        function calculateLevel(xp) {
            return Math.floor(Math.sqrt(xp / 100)) + 1;
        }

        function getSoulTitle(level) {
            const titles = [
                'Hollow', 'Unkindled', 'Bearer of the Curse', 'Ashen One',
                'Seeker of Fire', 'Keeper of Embers', 'Digital Wanderer',
                'Code Weaver', 'Render Knight', 'Shader Sorcerer',
                'Lord of Cinder', 'Transcendent'
            ];
            return titles[Math.min(level - 1, titles.length - 1)];
        }

        function updateSprintProgress(closedIssues) {
            // Count by issue ranges - adjust based on your actual issue numbering
            let sprint1Count = 0, sprint2Count = 0, sprint3Count = 0;
            
            closedIssues.forEach(issue => {
                if (issue.number >= 70 && issue.number <= 77) sprint1Count++;
                else if (issue.number >= 42 && issue.number <= 69) sprint2Count++;
                else if (issue.number >= 22 && issue.number <= 41) sprint3Count++;
            });
            
            updateBonfire('sprint-1', sprint1Count, 8);
            updateBonfire('sprint-2', sprint2Count, 28);
            updateBonfire('sprint-3', sprint3Count, 20);
            updateBonfire('side-quests', 0, 18); // Side quests not created yet
        }

        function updateBonfire(id, completed, total) {
            const element = document.getElementById(id);
            const percent = Math.round((completed / total) * 100);
            element.querySelector('.bonfire-header > div:nth-child(2)').textContent = `${percent}%`;
            element.querySelector('.bonfire-flame').style.width = `${percent}%`;
            
            if (percent === 100) {
                element.classList.add('lit');
            }
        }

        function generateMemoryGrid() {
            const grid = document.getElementById('memory-grid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 49; i++) {
                const fragment = document.createElement('div');
                fragment.className = 'soul-fragment';
                fragment.dataset.memoryId = i;
                fragment.textContent = i;
                
                if (i <= completedTasks) {
                    fragment.classList.add('obtained');
                    fragment.addEventListener('click', () => showMemory(i));
                }
                
                grid.appendChild(fragment);
            }
            
            document.getElementById('memories-unlocked').textContent = Math.min(completedTasks, 49);
        }

        function showMemory(id) {
            const modal = document.getElementById('story-modal');
            const memory = window.memoryFragments ? window.memoryFragments[id - 1] : null;
            
            if (memory) {
                document.getElementById('story-title').textContent = memory.title;
                document.getElementById('story-content').textContent = memory.text;
                
                // Play narration if enabled
                if (window.audioSystem && window.audioSystem.voEnabled) {
                    window.audioSystem.playMemoryNarration(memory.text, id);
                }
                
                // Award souls and embers
                console.log(`Memory ${id} unlocked: +${memory.souls} souls, +${memory.embers} embers`);
            } else {
                document.getElementById('story-title').textContent = `Memory Fragment ${id}`;
                document.getElementById('story-content').textContent = 
                    `The echoes of creation whisper: Fragment ${id} reveals the ancient knowledge of the digital realm...`;
            }
            
            modal.style.display = 'block';
        }

        // Initialize audio system
        let audioSystem = null;
        
        // Audio toggles
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // Initialize audio system
            audioSystem = new AudioSystem();
            window.audioSystem = audioSystem;
            
            // Auto-refresh every 5 minutes
            setInterval(loadData, 5 * 60 * 1000);
            
            // Audio controls
            document.getElementById('vo-toggle').addEventListener('click', function() {
                const enabled = audioSystem.toggleVO();
                this.classList.toggle('active', enabled);
                this.textContent = enabled ? 'Voice: British Lady' : 'Voice: Silent';
            });
            
            document.getElementById('music-toggle').addEventListener('click', function() {
                const enabled = audioSystem.toggleMusic();
                this.classList.toggle('active', enabled);
                this.textContent = enabled ? 'Ambience: Active' : 'Ambience: Silent';
            });
            
            // Story mode button
            document.getElementById('story-mode').addEventListener('click', function() {
                // Show all memories in sequence
                alert('Story mode: Experience all unlocked memories in sequence (coming soon)');
            });
            
            // Close modal handler
            document.getElementById('story-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    if (audioSystem) audioSystem.stopNarration();
                }
            });
        });
    </script>
</body>
</html>